<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Demo Voz con IA - Cabeza Clava</title>
</head>
<body>
  <h2>Habla y la Cabeza Clava responder√° con IA</h2>
  <button id="btnHablar">üé§ Hablar</button>
  <div id="conversacion"></div>

  <script>
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Tu navegador no soporta SpeechRecognition. Usa Chrome o Safari.");
    }

    const recognition = new SpeechRecognition();
    recognition.lang = "es-ES";
    recognition.continuous = false;
    recognition.interimResults = false;

    // ---- Configuraci√≥n de voces ----
    let vozEspanolMasculina = null;

    function cargarVozEspanolMasculina() {
      const voces = speechSynthesis.getVoices();
      vozEspanolMasculina = voces.find(
        v => v.lang.startsWith("es") && (
          v.name.toLowerCase().includes("male") ||
          v.name.toLowerCase().includes("diego") ||
          v.name.toLowerCase().includes("miguel") ||
          v.name.toLowerCase().includes("google espa√±ol")
        )
      );
      if (!vozEspanolMasculina) {
        vozEspanolMasculina = voces.find(v => v.lang.startsWith("es"));
      }
    }

    speechSynthesis.onvoiceschanged = cargarVozEspanolMasculina;

    // Forzar desbloqueo de audio en Safari
    document.body.addEventListener("click", () => {
      if (!window._vozInicializada) {
        const test = new SpeechSynthesisUtterance(" ");
        speechSynthesis.speak(test);
        window._vozInicializada = true;
      }
    });

    // ---- Bot√≥n para hablar ----
    document.getElementById("btnHablar").addEventListener("click", () => {
      recognition.start();
      console.log("üéôÔ∏è Escuchando...");
    });

    recognition.onresult = async (event) => {
      const texto = event.results[0][0].transcript;

      // Mostrar mensaje del usuario
      const divUsuario = document.createElement("p");
      divUsuario.textContent = "üë§ T√∫: " + texto;
      document.getElementById("conversacion").appendChild(divUsuario);

      // Llamar a la IA
      const respuesta = await preguntarIA(texto);

      // Mostrar respuesta de la IA
      const divIA = document.createElement("p");
      divIA.textContent = "üóø Cabeza Clava: " + respuesta;
      document.getElementById("conversacion").appendChild(divIA);

      // Reproducir voz
      hablar(respuesta);
    };

    recognition.onspeechend = () => {
      recognition.stop();
      console.log("üõë Fin de la grabaci√≥n");
    };

    recognition.onerror = (event) => {
      console.error("Error:", event.error);
      alert("Error en el reconocimiento de voz: " + event.error);
    };

    // ---- Funci√≥n para reproducir voz ----
    function hablar(texto) {
      const utter = new SpeechSynthesisUtterance(texto);
      utter.lang = "es-ES";
      utter.rate = 0.9; // estilo solemne, un poco m√°s lento
      if (vozEspanolMasculina) {
        utter.voice = vozEspanolMasculina;
      }
      speechSynthesis.speak(utter);
    }

    // ---- Llamada a Netlify Function ----
    async function preguntarIA(prompt) {
      const res = await fetch("/.netlify/functions/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      });
      const data = await res.json();
      return data.choices[0].message.content;
    }
  </script>
</body>
</html>
